# CÀI ĐẶT MÔI TRƯỜNG TÌM LỖI
Thông thường chúng tôi sẽ thực hiện tìm kiếm lỗ hổng bảo mật trực tiếp trên các
thiết bị thực tế. Tuy nhiên vì một số lý do không th mua được thiết bị trong thời
điểm hiện tại nên chúng tôi tiến hành ảo hóa thiết bị để có thể tìm kiếm lỗ hổng
bảo mật. Dưới đây là chi tiết các bước để ảo hóa thiết bị này.
Download và extract firmware:
```
datnlq@ubuntu:~/totolink$ binwalk -e TOTOLINK_C8380R_X6000R_IP04499_MT7981_SPI_16M256M_V9.4.0cu.1360_B20241207_ALL.web
datnlq@ubuntu:~/totolink/_TOTOLINK_C8380R_X6000R_IP04499_MT7981_SPI_16M256M_V9.4.0cu.1360_B20241207_ALL.web.extracted$ ls
2E0000.squashfs  E8  E8.7z  squashfs-root  squashfs-root-0
```


Sử dụng lệnh file, xác định được firmware chạy trên kiến trúc ARM aarch64:
```
datnlq@ubuntu:~/totolink/_TOTOLINK_C8380R_X6000R_IP04499_MT7981_SPI_16M256M_V9.4.0cu.1360_B20241207_ALL.web.extracted$ file squashfs-root/bin/*
squashfs-root/bin/ash:             symbolic link to busybox
squashfs-root/bin/board_detect:    POSIX shell script, ASCII text executable
squashfs-root/bin/busybox:         ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-aarch64.so.1, no section header
```

Tạo rootfs cho thiết bị từ thư mục squashfs-root để tiến hành ảo hóa:
```
$ tar -czf rootfs.tar.gz squashfs-root
```

Tạo các file sh cần thiết để tiện cho việc giả lập, debug:


file mount chroot.sh
```
#!/bin/sh
# file mount_chroot.sh
mkdir var/run
sudo mount -o bind /proc proc/
sudo mount -o bind /dev dev/
sudo mount -o bind /sys sys/
sudo chroot . /bin/sh
```
file runservice.sh
```
#!/bin/sh
# file runservice.sh
# /usr/sbin/lighttpd -f /etc/lighttpd/lighttpd.conf
#./usr/sbin/shttpd -p 8080 -d ./www
#./usr/sbin/shttpd -p 8080 -d ./web
./usr/sbin/shttpd -ports 8080 -root ./web
```

Tạo file emulator.sh và chạy emulator, username và password là ubuntu / asdfqwer:
```
#!/bin/bash

# Cài đặt QEMU cho kiến trúc aarch64
sudo apt-get update
sudo apt-get install qemu-system-aarch64 cloud-image-utils -y

# Tạo user-data nếu chưa tồn tại
user_data="user-data.img"
if [ ! -f "$user_data" ]; then
cat > user-data <<EOF
#cloud-config
password: asdfqwer
chpasswd: { expire: False }
ssh_pwauth: True
packages:
  - lighttpd
EOF

cloud-localds "$user_data" user-data
fi

# Tải ảnh hệ điều hành nếu chưa có
img="ubuntu-18.04-server-cloudimg-arm64.img"
if [ ! -f "$img" ]; then
    wget "https://cloud-images.ubuntu.com/releases/18.04/release/${img}" --no-check-certificate
fi

# Tải UEFI firmware nếu chưa có
if [ ! -f "QEMU_EFI.fd" ]; then
    wget https://releases.linaro.org/components/kernel/uefi-linaro/16.02/release/qemu64/QEMU_EFI.fd --no-check-certificate
fi

# Khởi chạy QEMU
sudo qemu-system-aarch64 \
    -m 2048 \
    -cpu cortex-a72 \
    -smp 4 \
    -M virt \
    -nographic \
    -bios QEMU_EFI.fd \
    -drive if=none,file="${img}",id=hd0 \
    -device virtio-blk-device,drive=hd0 \
    -drive file="${user_data}",format=raw \
    -device virtio-net-device,netdev=net0 \
    -netdev user,id=net0,hostfwd=tcp::8080-:8080,hostfwd=tcp::8008-:8008,hostfwd=tcp::2222-:22,hostfwd=tcp::8181-:8181,hostfwd=tcp::9999-:9999,hostfwd=tcp::443-:443

```

```
$ chmod +x./emulator.sh
$ sudo ./emulator.sh
```


Sử dụng scp để đưa file rootfs.tar.gz vào máy ảo giả lập:
$ scp -P2222 ./rootfs.tar.gz ubuntu@127.0.0.1:/tmp
$ scp -P2222 ./mount_chroot.sh ubuntu@127.0.0.1:/tmp
$ scp -P2222 ./runservice.sh ubuntu@127.0.0.1:/tmp


Trên máy ảo giả lập thực hiện extract rootfs.tar.gz và các file sh cần thiết:
```
$ sudo mkdir /home/X6000R
$ sudo chown ubuntu:ubuntu /home/X6000R
$ mv /tmp/rootfs.tar.gz /home/X6000R/
$ cd/home/X6000R
$ tar -xf rootfs.tar.gz
$ cd /home/X6000R/squashfs-root
$ mv /tmp/mount_chroot.sh .
$ mv /tmp/runservice.sh .
$ chmod +x ./runservice.sh
$ chmod +x ./mount chroot.sh
$./mount_chroot.sh
```
BusyBox v1.25.1 Q built-in shell (ash)
/ #./runservice.sh
2021-08-21 13:44:04: (log.c.166) server started
Kiểm tra kết nối tới dịch vụ:


Unmount khỏi máy chính
```
sudo umount ./proc
sudo umount ./sys
sudo umount ./dev/pts
sudo umount ./dev
```